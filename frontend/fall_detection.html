<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fall Detection - Elder Caretaker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }
        
        :root {
            --bg: #f8f9fa;
            --card: #ffffff;
            --primary: #4e73df;
            --success: #1cc88a;
            --danger: #e74a3b;
            --warning: #f6c23e;
            --text: #5a5c69;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .upload-section, .results-section {
            background: var(--card);
            border-radius: 10px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #videoPlayer {
            width: 100%;
            display: block;
        }
        
        .controls {
            background: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-upload {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-upload:hover {
            background-color: #2e59d9;
            transform: translateY(-2px);
        }
        
        .btn-upload:disabled {
            background-color: #b7c1d8;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 5px;
            background-color: #f8f9fc;
            border-left: 4px solid var(--primary);
        }
        
        .alert {
            margin-top: 1rem;
            border-radius: 5px;
        }
        
        .fall-detected {
            border: 3px solid var(--danger) !important;
            box-shadow: 0 0 15px rgba(231, 74, 59, 0.5);
        }
        
        .progress {
            height: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text);
            opacity: 0.8;
        }
        
        .alert {
            margin-top: 1rem;
            border-radius: 5px;
        }
        
        .fall-detected {
            border: 3px solid var(--danger) !important;
            box-shadow: 0 0 15px rgba(231, 74, 59, 0.5);
        }
        
        .progress {
            height: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    

    <div class="container mt-5">
        <h2 class="text-center mb-4">Fall Detection Analysis</h2>
        
        <!-- Upload Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Upload Video</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="videoUpload" class="form-label">Select video file (MP4, AVI, MOV)</label>
                    <input class="form-control" type="file" id="videoUpload" accept="video/*">
                </div>
                <div class="d-flex gap-2">
                    <button id="uploadBtn" class="btn btn-primary">
                        <span id="uploadBtnText">Upload & Analyze</span>
                        <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </span>
                    </button>
                    <button id="cancelBtn" class="btn btn-outline-secondary" disabled>Cancel</button>
                </div>
                
                <!-- Upload Status -->
                <div id="uploadStatus" class="mt-3 d-none">
                    <div class="progress mb-2">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span id="statusText">Uploading...</span>
                        <span id="progressText">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="d-none">
            <!-- Fall Detection Result Card -->
            <div class="card mb-4" id="fallResultCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Fall Detection Result</h5>
                    <span id="fallStatusBadge" class="badge"></span>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div id="fallIcon" class="me-3" style="font-size: 2.5rem;"></div>
                        <div>
                            <h4 id="fallResultTitle" class="mb-1">Analysis Complete</h4>
                            <p id="fallResultMessage" class="mb-0">The video has been analyzed for fall detection.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert d-none" id="resultsAlert" role="alert">
                <div id="resultsMessage"></div>
            </div>
            
            <!-- Analysis Results -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API_BASE_URL = 'http://127.0.0.1:8000/api';  
        // Helper function to safely add event listeners
        function safeAddEventListener(element, event, handler) {
            if (element && typeof handler === 'function') {
                element.addEventListener(event, handler);
            } else {
                console.warn(`Could not add ${event} listener to`, element);
            }
        }

        // State variables
        let isProcessing = false;
        let checkStatusInterval = null;
        const token = localStorage.getItem('token');
        
        // Check authentication
        if (!token) {
            window.location.href = 'index.html';
            return; // Stop execution if not authenticated
        }
        
        // DOM Elements
        const videoUpload = document.getElementById('videoUpload');
        const uploadBtn = document.getElementById('uploadBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const statusText = document.getElementById('statusText');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const resultsSection = document.getElementById('resultsSection');
        const resultsAlert = document.getElementById('resultsAlert');
        const resultsMessage = document.getElementById('resultsMessage');
        const fallResults = document.getElementById('fallResults');
        
        // State
        let processId = null;
        let fallEvents = [];
        
        // Event Listeners
        // Event Listeners with null checks
        safeAddEventListener(uploadBtn, 'click', handleUpload);
        safeAddEventListener(cancelBtn, 'click', cancelUpload);
        
        // Handle video upload and processing
        async function handleUpload() {
            const file = videoUpload.files[0];
            if (!file) {
                showAlert('Please select a video file first', 'warning');
                return;
            }
            
            // Validate file size (100MB max)
            if (file.size > 100 * 1024 * 1024) {
                showAlert('File size exceeds 100MB limit', 'danger');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // Update UI for processing
                isProcessing = true;
                uploadBtn.disabled = true;
                cancelBtn.disabled = false;
                document.getElementById('uploadBtnText').textContent = 'Processing...';
                document.getElementById('uploadSpinner').classList.remove('d-none');
                uploadStatus.classList.remove('d-none');
                statusText.textContent = 'Uploading video...';
                
                // Show upload progress
                const config = {
                    onUploadProgress: function(progressEvent) {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        updateProgress(percentCompleted, 'Uploading video...');
                    }
                };
                
                // Get JWT token from local storage
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Upload video
                const response = await fetch(`${API_BASE_URL}/fall-detection/process-video`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to process video');
                }
                
                const data = await response.json();
                processId = data.process_id;
                
                // Show processing status
                updateProgress(30, 'Analyzing video for falls...');
                
                // Start checking status
                if (data.process_id) {
                    processId = data.process_id;
                    checkStatus(processId);  // Pass the process ID
                }
                
            } catch (error) {
                console.error('Error uploading video:', error);
                showAlert(`Error: ${error.message}`, 'danger');
                resetUploadUI();
            }
        }
        
        // Check processing status
        async function checkStatus(processId) {
            if (!processId) {
                console.error('No process ID provided');
                return;
            }
            
            // Clear any existing interval first to prevent multiple checks
            clearStatusInterval();
            
            try {
                console.log(`Checking status for process ID: ${processId}`);
                const response = await fetch(`${API_BASE_URL}/fall-detection/status/${processId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const status = await response.json();
                console.log('Status response:', status);
                
                if (status.status === 'completed') {
                    console.log('Processing completed, showing results');
                    clearStatusInterval();
                    isProcessing = false;
                    resetUploadUI();
                    showResults(status);
                    return;
                } 
                
                if (status.status === 'error') {
                    console.error('Processing error:', status.error || 'Unknown error');
                    clearStatusInterval();
                    isProcessing = false;
                    resetUploadUI();
                    showAlert(`Error: ${status.error || 'Processing failed'}`, 'danger');
                    return;
                }
                
                // Still processing, update progress and check again
                console.log(`Still processing... (status: ${status.status})`);
                if (status.progress) {
                    updateProgress(status.progress, `Processing: ${status.progress}%`);
                }
                
                // Set a new timeout for the next check
                checkStatusInterval = setTimeout(() => {
                    checkStatus(processId);
                }, 1000);
                
            } catch (error) {
                console.error('Error checking status:', error);
                clearStatusInterval();
                isProcessing = false;
                resetUploadUI();
                showAlert(`Error: ${error.message}`, 'danger');
            }
        }
        
        // Show results function
        function showResults(results) {
            // Show the results section if it's hidden
            document.getElementById('resultsSection').classList.remove('d-none');
            const fallResultCard = document.getElementById('fallResultCard');
            const fallStatusBadge = document.getElementById('fallStatusBadge');
            const fallIcon = document.getElementById('fallIcon');
            const fallResultTitle = document.getElementById('fallResultTitle');
            const fallResultMessage = document.getElementById('fallResultMessage');
            
            // Show the result card
            fallResultCard.style.display = 'block';
            
            // Check if fall was detected - looking for fall events in the response
            const fallEvents = results.falls_detected || [];
            const hasFalls = fallEvents.length > 0 || 
                           results.fall_detected || 
                           (results.frames && results.frames.some(frame => frame.fall_detected));
            
            if (hasFalls) {
                // Fall detected - show warning
                fallResultCard.classList.remove('border-success', 'border-warning');
                fallResultCard.classList.add('border-danger');
                fallStatusBadge.className = 'badge bg-danger';
                fallStatusBadge.textContent = 'Fall Detected';
                fallIcon.className = 'fas fa-exclamation-triangle text-danger';
                fallResultTitle.textContent = 'Fall Detected!';
                fallResultMessage.textContent = 'A fall was detected in the video. Please review the details below.';
                
                // Show alert and send email
                showAlert('Fall detected! An alert has been sent to the caregiver.', 'danger', true);
                
                // Send fall alert email
                const fallDetails = {
                    timestamp: new Date().toISOString(),
                    confidence: results.confidence || 'High',
                    video_duration: results.duration || 'Unknown',
                    fall_count: fallEvents.length || 1
                };
                sendFallAlertEmail(fallDetails);
            } else {
                // No fall detected - show success
                fallResultCard.classList.remove('border-danger', 'border-warning');
                fallResultCard.classList.add('border-success');
                fallStatusBadge.className = 'badge bg-success';
                fallStatusBadge.textContent = 'No Fall Detected';
                fallIcon.className = 'fas fa-check-circle text-success';
                fallResultTitle.textContent = 'No Fall Detected';
                fallResultMessage.textContent = 'No falls were detected in the video.';
            }
            try {
                console.log('Showing results:', results);
                
                // Update UI
                resultsSection.style.display = 'block';
                uploadStatus.classList.add('d-none');
                
                // Check for falls_detected in the response
                const fallEvents = results.falls_detected || [];
                const hasFalls = fallEvents.length > 0 || results.has_falls === true;
                
                // Update results display
                if (hasFalls) {
                    // Show critical alert with sound
                    showAlert(
                        `<strong>EMERGENCY:</strong> ${fallEvents.length} fall${fallEvents.length === 1 ? '' : 's'} detected in the video. Caregiver has been notified.`,
                        'danger',
                        true
                    );
                    
                    // Send email notification
                    sendFallAlertEmail(fallEvents);
                    
                    resultsAlert.className = 'alert alert-danger';
                    resultsMessage.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>${fallEvents.length > 0 ? fallEvents.length + ' fall' + (fallEvents.length === 1 ? '' : 's') : 'Falls'} detected</strong> in the video. Caregiver has been notified.
                    `;
                    resultsAlert.style.display = 'block';
                    
                    // Create table HTML for fall events
                    const tableHtml = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Confidence</th>
                                        <th>Angle</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fallEvents.length > 0 ? fallEvents.map((fall, index) => {
                                        const timestamp = fall.timestamp_seconds ? 
                                            formatTimestamp(fall.timestamp_seconds) : (fall.timestamp || 'N/A');
                                        const confidence = fall.confidence ? 
                                            `${Math.round(fall.confidence * 100)}%` : 'N/A';
                                        const angle = fall.angle ? 
                                            `${fall.angle.toFixed(1)}Â°` : 'N/A';
                                        
                                        return `
                                            <tr>
                                                <td>${timestamp}</td>
                                                <td>${confidence}</td>
                                                <td>${angle}</td>
                                            </tr>
                                        `;
                                    }).join('') : `
                                        <tr>
                                            <td colspan="3" class="text-center">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Fall detected (check console for details)
                                            </td>
                                        </tr>`}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    fallResults.innerHTML = tableHtml;
                } else {
                    resultsAlert.className = 'alert alert-success';
                    resultsMessage.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>No falls detected</strong> in the video.
                    `;
                    resultsAlert.style.display = 'block';
                    fallResults.innerHTML = '<p class="text-muted">No fall events were detected in the video.</p>';
                }
                
                // Scroll to results
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error in showResults:', error);
                showAlert(`Error displaying results: ${error.message}`, 'danger');
            }
        }
        
        // Format timestamp in HH:MM:SS format
        function formatTimestamp(seconds) {
            const date = new Date(0);
            date.setSeconds(seconds);
            return date.toISOString().substr(11, 8);
        }
        
        // Cancel upload/processing
        function cancelUpload() {
            if (confirm('Are you sure you want to cancel the current operation?')) {
                // Clear any pending status checks
                clearStatusInterval();
                
                // Reset the UI and show cancellation message
                resetUploadUI();
                showAlert('Operation cancelled', 'warning');
                
                // In a real implementation, you might want to send a cancellation request to the server
                // This would require a new API endpoint to handle cancellation
                // fetch(`${API_BASE_URL}/fall-detection/cancel/${processId}`, {
                //     method: 'POST',
                //     headers: {
                //         'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                //     }
                // });
            }
        }
        
        // Clear status interval helper function
        function clearStatusInterval() {
            if (checkStatusInterval) {
                clearTimeout(checkStatusInterval);
                checkStatusInterval = null;
            }
        }
        
        // Reset upload UI
        function resetUploadUI() {
            // Clear any existing intervals
            clearStatusInterval();
            
            // Reset processing state
            isProcessing = false;
            
            // Reset UI elements
            uploadBtn.disabled = false;
            cancelBtn.disabled = true;
            uploadStatus.classList.add('d-none');
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            statusText.textContent = 'Ready';
            
            const uploadBtnText = document.getElementById('uploadBtnText');
            if (uploadBtnText) uploadBtnText.textContent = 'Upload & Analyze';
            
            const uploadSpinner = document.getElementById('uploadSpinner');
            if (uploadSpinner) uploadSpinner.classList.add('d-none');
            
            // Enable the file input
            if (videoUpload) videoUpload.disabled = false;
        }
        
        // Reset form for new analysis
        function resetForm() {
            videoUpload.value = '';
            resultsSection.style.display = 'none';
            
            // Clear results
            if (fallResults) {
                fallResults.innerHTML = '';
            }
            
            // Reset results alert
            if (resultsAlert) {
                resultsAlert.style.display = 'none';
            }
            
            // Reset progress
            updateProgress(0, 'Ready');
        }
        
        // Update progress
        function updateProgress(percent, message) {
            progressBar.style.width = `${percent}%`;
            progressBar.setAttribute('aria-valuenow', percent);
            progressText.textContent = `${percent}%`;
            statusText.textContent = message;
        }
        
        // Function to send fall detection email
        async function sendFallAlertEmail(fallDetails) {
            try {
                const response = await fetch('http://127.0.0.1:8000/api/emergency/fall-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        message: 'FALL DETECTED: Immediate attention required!',
                        timestamp: new Date().toISOString(),
                        fallCount: fallDetails.length,
                        fallDetails: fallDetails,
                        location: 'Fall Detection System',
                        videoUrl: document.getElementById('videoPlayer').src || 'N/A'
                    })
                });

                if (!response.ok) {
                    console.error('Failed to send fall alert email');
                }
            } catch (error) {
                console.error('Error sending fall alert email:', error);
            }
        }

        // Show alert with sound and notification
        function showAlert(message, type = 'info', playSound = false) {
            // Play alert sound for important messages
            if (playSound) {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
                audio.play().catch(e => console.error('Error playing alert sound:', e));
                
                // Browser notification if allowed
                if (Notification.permission === 'granted') {
                    new Notification('Fall Detected!', {
                        body: 'A fall has been detected in the video.',
                        icon: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
                        requireInteraction: true
                    });
                }
            }

            // Create and show the alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <div>${message}</div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Add animation for important alerts
            if (type === 'danger') {
                alertDiv.style.animation = 'pulse 2s infinite';
                document.body.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 2000);
            }
            
            const container = document.getElementById('alertsContainer');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-dismiss after 10 seconds for non-critical alerts, 30 for critical
            const timeout = type === 'danger' ? 30000 : 10000;
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                    bsAlert.close();
                }
            }, timeout);
        }
        
        // Handle video download
        function downloadProcessedVideo() {
            try {
                if (!processId) {
                    showAlert('No processed video available to download', 'warning');
                    return;
                }

                // Get the current status to find the output file
                const status = process_status[processId];
                if (!status || !status.output_file) {
                    showAlert('No processed video file found', 'warning');
                    return;
                }

                // Create a temporary link element
                const link = document.createElement('a');
                
                // Set the download URL to the processed video
                const videoUrl = `${API_BASE_URL}/videos/${status.output_file}`;
                
                // Generate a user-friendly filename
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `fall-detection-${timestamp}.mp4`;
                
                // Set up the link for download
                link.href = videoUrl;
                link.download = filename;
                
                // Trigger the download
                document.body.appendChild(link);
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(videoUrl);
                }, 100);
                
            } catch (error) {
                console.error('Error downloading video:', error);
                showAlert(`Error downloading video: ${error.message}`, 'danger');
            }
        }
        
        // Handle logout
        function handleLogout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }
        
        // Authentication check already performed at the top
    }); // End of DOMContentLoaded
    </script>
</body>
</html>
